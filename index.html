<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi d'Inventaire de M√©dicaments</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .content {
        padding: 30px;
      }

      .toolbar {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f8f9ff;
        color: #667eea;
        border: 2px solid #667eea;
      }

      .btn-secondary:hover {
        background: #667eea;
        color: white;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-info {
        background: #3b82f6;
        color: white;
      }

      .btn-info:hover {
        background: #2563eb;
      }

      input[type="file"] {
        display: none;
      }

      .file-label {
        padding: 12px 24px;
        background: #f8f9ff;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .file-label:hover {
        background: #667eea;
        color: white;
      }

      .add-medicine-section {
        background: #f8f9ff;
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .add-medicine-section h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .add-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .form-group label {
        font-size: 0.9em;
        font-weight: 600;
        color: #555;
      }

      .form-group input {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 0.9em;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.5em;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 40px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        font-size: 0.9em;
      }

      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        vertical-align: middle;
      }

      td input[type="number"] {
        width: 80px;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background-color: #f8f9ff;
      }

      .medicine-name {
        font-weight: 600;
        color: #333;
      }

      .quantity-badge {
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.9em;
        text-align: center;
        display: inline-block;
        min-width: 40px;
      }

      .consumption-badge {
        background: #ef4444;
      }

      .data-section {
        margin-top: 40px;
        padding-top: 40px;
        border-top: 2px solid #e0e0e0;
      }

      .delete-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
        transition: background 0.3s;
      }

      .delete-btn:hover {
        background: #dc2626;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease-out;
        z-index: 1000;
      }

      .notification.success {
        background: #10b981;
      }
      .notification.error {
        background: #ef4444;
      }
      .notification.info {
        background: #3b82f6;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .instructions {
        background: #f8f9ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
      }
      .instructions p {
        margin-bottom: 8px;
        color: #555;
      }
      .instructions strong {
        color: #667eea;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .date-checkboxes {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: #f8f9ff;
        border-radius: 6px;
        transition: all 0.2s;
      }
      .checkbox-item:hover {
        background: #e8ebff;
      }
      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #667eea;
      }
      .checkbox-item label {
        cursor: pointer;
        font-size: 0.9em;
        color: #555;
        user-select: none;
        flex: 1;
      }
      .total-value {
        font-size: 1.2em;
        font-weight: 700;
        color: #667eea;
        padding: 8px 16px;
        background: #f8f9ff;
        border-radius: 8px;
        display: inline-block;
      }

      .sort-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }
      .sort-btn,
      .toggle-btn {
        padding: 8px 16px;
        background: #f8f9ff;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9em;
      }
      .sort-btn:hover,
      .toggle-btn:hover {
        background: #667eea;
        color: white;
      }
      .sort-btn.active {
        background: #667eea;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üíä Suivi d'Inventaire de M√©dicaments</h1>
        <p>G√©rez votre inventaire de m√©dicaments de mission</p>
      </header>

      <div class="content">
        <div class="toolbar">
          <button class="btn btn-info" id="saveJsonBtn">
            üíæ Enregistrer les Donn√©es
          </button>

          <label for="excelFile" class="file-label"> üì§ Importer Excel </label>
          <input type="file" id="excelFile" accept=".xlsx,.xls" />

          <button class="btn btn-secondary" id="exportDataBtn">
            üìä Exporter les Donn√©es
          </button>

          <button class="btn btn-danger" id="clearBtn">
            üóëÔ∏è Effacer Toutes les Donn√©es
          </button>
        </div>

        <div class="instructions">
          <p>
            <strong>√âtape 1 :</strong> Les donn√©es sont automatiquement charg√©es
            depuis le fichier `data.json`.
          </p>
          <p>
            <strong>Colonnes Excel :</strong> Medicine, Expiration Date, Last
            Mission Remainder, Planned Purchase
          </p>
          <p>
            <strong>√âtape 2 :</strong> Quand une mission est termin√©e,
            remplissez la colonne <strong>Qt√© Apr√®s Mission</strong> dans le
            tableau ci-dessous. La consommation sera calcul√©e automatiquement.
          </p>
          <p>
            <strong>√âtape 3 :</strong> Cliquez sur
            <strong>Enregistrer les Donn√©es</strong> pour t√©l√©charger le fichier
            mis √† jour.
          </p>
        </div>

        <div class="add-medicine-section">
          <h3>‚ûï Ajouter une Nouvelle Entr√©e</h3>
          <div class="add-form">
            <div class="form-group">
              <label for="medicineName">Nom du M√©dicament</label>
              <input type="text" id="medicineName" placeholder="ex: Aspirine" />
            </div>
            <div class="form-group">
              <label for="expirationDate">Date d'Expiration</label>
              <input
                type="text"
                id="expirationDate"
                placeholder="ex: 01/07/2027"
              />
            </div>
            <div class="form-group">
              <label for="lastMissionRemainder">Reste Mission Pr√©c.</label>
              <input
                type="number"
                id="lastMissionRemainder"
                placeholder="ex: 20"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="plannedPurchase">Achat Pr√©vu</label>
              <input
                type="number"
                id="plannedPurchase"
                placeholder="ex: 100"
                min="0"
              />
            </div>
            <button class="btn btn-primary" id="addMedicineBtn">
              ‚ûï Ajouter
            </button>
          </div>
        </div>

        <div class="section-header">
          <h2>R√©sum√©</h2>
        </div>
        <div class="sort-controls">
          <span>Trier par :</span>
          <button id="sortSummaryByName" class="sort-btn active">
            Nom du M√©dicament ‚ñ≤
          </button>
        </div>
        <table id="summaryTable">
          <thead>
            <tr>
              <th>M√©dicament</th>
              <th>Lots par Date d'Expiration</th>
              <th>Total S√©lectionn√©</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>

        <div class="data-section" id="data-section-container">
          <div class="section-header">
            <h2>Fiche de Donn√©es</h2>
            <button id="toggleDataSheetBtn" class="toggle-btn">Masquer</button>
          </div>
          <div class="sort-controls" id="dataSheetSortControls">
            <span>Trier par :</span>
            <button id="sortDataByName" class="sort-btn active">
              Nom du M√©dicament
            </button>
            <button id="sortDataByDate" class="sort-btn">
              Date d'Expiration
            </button>
          </div>
          <table id="dataTable">
            <thead>
              <tr>
                <th>M√©dicament</th>
                <th>Date d'Exp.</th>
                <th>Reste Mission Pr√©c.</th>
                <th>Achat Pr√©vu</th>
                <th>Qt√© Avant Mission</th>
                <th>Consommation</th>
                <th>Qt√© Apr√®s Mission</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="dataBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      let dataSheet = [
        {
          medicine: "Aspirine",
          expirationDate: "01/07/2027",
          lastMissionRemainder: 20,
          plannedPurchase: 100,
          quantityBeforeMission: 120,
          consumption: null,
          quantityAfterMission: null,
        },
        {
          medicine: "Parac√©tamol",
          expirationDate: "01/07/2025",
          lastMissionRemainder: 0,
          plannedPurchase: 100,
          quantityBeforeMission: 100,
          consumption: null,
          quantityAfterMission: null,
        },
      ];

      // Sorting State
      let summarySortOrder = "asc";
      let dataSheetSortKey = "medicine";
      let dataSheetSortOrder = "asc";

      function parseDate(dateStr) {
        const parts = dateStr.split("/");
        if (parts.length === 3) {
          return `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(
            2,
            "0"
          )}`;
        }
        return dateStr;
      }

      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      function saveSelectionsToLocalStorage() {
        const selections = {};
        document
          .querySelectorAll('#summaryTable input[type="checkbox"]')
          .forEach((cb) => {
            const key = `${cb.dataset.medicine}-${cb.dataset.date}`;
            selections[key] = cb.checked;
          });
        localStorage.setItem("medicineSelections", JSON.stringify(selections));
      }

      function groupByMedicine(data) {
        return data.reduce((acc, item) => {
          (acc[item.medicine] = acc[item.medicine] || []).push({
            date: item.expirationDate,
            quantity: item.quantityBeforeMission,
          });
          return acc;
        }, {});
      }

      function calculateTotal(medicine) {
        return Array.from(
          document.querySelectorAll(
            `input[data-medicine="${medicine}"]:checked`
          )
        ).reduce((total, cb) => total + parseInt(cb.dataset.quantity), 0);
      }

      function updateTotal(medicine) {
        const total = calculateTotal(medicine);
        const totalCell = document.getElementById(`total-${medicine}`);
        if (totalCell) {
          totalCell.textContent = total;
        }
        saveSelectionsToLocalStorage();
      }

      function renderSummary() {
        const grouped = groupByMedicine(dataSheet);
        const summaryBody = document.getElementById("summaryBody");
        summaryBody.innerHTML = "";
        const savedSelections = JSON.parse(
          localStorage.getItem("medicineSelections") || "{}"
        );

        const sortedMedicines = Object.keys(grouped).sort((a, b) => {
          const comparison = a.localeCompare(b);
          return summarySortOrder === "asc" ? comparison : -comparison;
        });

        sortedMedicines.forEach((medicine) => {
          const row = document.createElement("tr");
          const medicineCell = document.createElement("td");
          medicineCell.className = "medicine-name";
          medicineCell.textContent = medicine;
          const dateCell = document.createElement("td");
          const checkboxContainer = document.createElement("div");
          checkboxContainer.className = "date-checkboxes";
          grouped[medicine].sort((a, b) =>
            parseDate(a.date).localeCompare(parseDate(b.date))
          );
          grouped[medicine].forEach((item, index) => {
            const checkboxItem = document.createElement("div");
            checkboxItem.className = "checkbox-item";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            const checkboxId = `${medicine.replace(
              /\s+/g,
              "_"
            )}-${item.date.replace(/\//g, "-")}-${index}`;
            checkbox.id = checkboxId;
            checkbox.dataset.medicine = medicine;
            checkbox.dataset.date = item.date;
            checkbox.dataset.quantity = item.quantity;
            const key = `${medicine}-${item.date}`;
            if (savedSelections[key]) checkbox.checked = true;
            checkbox.addEventListener("change", () => updateTotal(medicine));
            const label = document.createElement("label");
            label.htmlFor = checkboxId;
            label.innerHTML = `${item.date} <span class="quantity-badge">${item.quantity}</span>`;
            checkboxItem.append(checkbox, label);
            checkboxContainer.appendChild(checkboxItem);
          });
          dateCell.appendChild(checkboxContainer);
          const totalCell = document.createElement("td");
          const totalValue = document.createElement("span");
          totalValue.className = "total-value";
          totalValue.id = `total-${medicine}`;
          totalCell.appendChild(totalValue);
          row.append(medicineCell, dateCell, totalCell);
          summaryBody.appendChild(row);
          updateTotal(medicine);
        });
      }

      function updateConsumption(index) {
        const rowInput = document.getElementById(`qam-${index}`);
        const newQAM = rowInput.value !== "" ? parseInt(rowInput.value) : null;
        if (newQAM === null) {
          dataSheet[index].quantityAfterMission = null;
          dataSheet[index].consumption = null;
        } else {
          const quantityBefore = dataSheet[index].quantityBeforeMission;
          if (newQAM > quantityBefore) {
            showNotification(
              "La Qt√© apr√®s mission ne peut pas d√©passer la Qt√© avant.",
              "error"
            );
            rowInput.value =
              dataSheet[index].quantityAfterMission !== null
                ? dataSheet[index].quantityAfterMission
                : "";
            return;
          }
          dataSheet[index].quantityAfterMission = newQAM;
          dataSheet[index].consumption = quantityBefore - newQAM;
        }
        renderDataTable();
        showNotification("Consommation mise √† jour !", "info");
      }

      function renderDataTable() {
        const dataBody = document.getElementById("dataBody");
        dataBody.innerHTML = "";
        const indexedData = dataSheet.map((item, index) => ({
          item,
          originalIndex: index,
        }));
        indexedData.sort((a, b) => {
          let valA, valB;
          if (dataSheetSortKey === "expirationDate") {
            valA = parseDate(a.item.expirationDate);
            valB = parseDate(b.item.expirationDate);
          } else {
            valA = a.item.medicine.toLowerCase();
            valB = b.item.medicine.toLowerCase();
          }
          if (valA < valB) return dataSheetSortOrder === "asc" ? -1 : 1;
          if (valA > valB) return dataSheetSortOrder === "asc" ? 1 : -1;
          return 0;
        });

        indexedData.forEach(({ item, originalIndex }) => {
          const row = document.createElement("tr");
          const consumptionValue =
            item.consumption !== null
              ? `<span class="quantity-badge consumption-badge">${item.consumption}</span>`
              : "";
          const qamValue =
            item.quantityAfterMission !== null ? item.quantityAfterMission : "";
          row.innerHTML = `
            <td class="medicine-name">${item.medicine}</td>
            <td>${item.expirationDate}</td>
            <td>${item.lastMissionRemainder}</td>
            <td>${item.plannedPurchase}</td>
            <td><span class="quantity-badge">${item.quantityBeforeMission}</span></td>
            <td>${consumptionValue}</td>
            <td>
                <input type="number" id="qam-${originalIndex}" value="${qamValue}" min="0" onchange="updateConsumption(${originalIndex})"/>
            </td>
            <td>
                <button class="delete-btn" onclick="deleteMedicine(${originalIndex})">üóëÔ∏è Supprimer</button>
            </td>
          `;
          dataBody.appendChild(row);
        });
      }

      function deleteMedicine(index) {
        if (confirm("√ätes-vous s√ªr de vouloir supprimer cette entr√©e ?")) {
          dataSheet.splice(index, 1);
          rerenderAll();
          showNotification("Entr√©e supprim√©e avec succ√®s.", "info");
        }
      }

      document
        .getElementById("addMedicineBtn")
        .addEventListener("click", (e) => {
          const medicine = document.getElementById("medicineName").value.trim();
          const expirationDate = document
            .getElementById("expirationDate")
            .value.trim();
          const lastMissionRemainder =
            parseInt(document.getElementById("lastMissionRemainder").value) ||
            0;
          const plannedPurchase =
            parseInt(document.getElementById("plannedPurchase").value) || 0;

          if (!medicine || !expirationDate) {
            showNotification(
              "Le nom du m√©dicament et la date d'expiration sont requis.",
              "error"
            );
            return;
          }

          dataSheet.push({
            medicine,
            expirationDate,
            lastMissionRemainder,
            plannedPurchase,
            quantityBeforeMission: lastMissionRemainder + plannedPurchase,
            consumption: null,
            quantityAfterMission: null,
          });

          rerenderAll();
          document.getElementById("medicineName").value = "";
          document.getElementById("expirationDate").value = "";
          document.getElementById("lastMissionRemainder").value = "";
          document.getElementById("plannedPurchase").value = "";

          showNotification("M√©dicament ajout√© avec succ√®s !", "success");
        });

      document
        .getElementById("sortSummaryByName")
        .addEventListener("click", (e) => {
          summarySortOrder = summarySortOrder === "asc" ? "desc" : "asc";
          e.target.textContent = `Nom du M√©dicament ${
            summarySortOrder === "asc" ? "‚ñ≤" : "‚ñº"
          }`;
          renderSummary();
        });

      document
        .getElementById("sortDataByName")
        .addEventListener("click", (e) => {
          dataSheetSortKey = "medicine";
          dataSheetSortOrder = dataSheetSortOrder === "asc" ? "desc" : "asc";
          document.getElementById("sortDataByDate").classList.remove("active");
          e.target.classList.add("active");
          renderDataTable();
        });

      document
        .getElementById("sortDataByDate")
        .addEventListener("click", (e) => {
          dataSheetSortKey = "expirationDate";
          dataSheetSortOrder = dataSheetSortOrder === "asc" ? "desc" : "asc";
          document.getElementById("sortDataByName").classList.remove("active");
          e.target.classList.add("active");
          renderDataTable();
        });

      document
        .getElementById("toggleDataSheetBtn")
        .addEventListener("click", (e) => {
          const table = document.getElementById("dataTable");
          const controls = document.getElementById("dataSheetSortControls");
          const isHidden = table.style.display === "none";
          if (isHidden) {
            table.style.display = "";
            controls.style.display = "flex";
            e.target.textContent = "Masquer";
          } else {
            table.style.display = "none";
            controls.style.display = "none";
            e.target.textContent = "Afficher";
          }
        });

      document.getElementById("saveJsonBtn").addEventListener("click", () => {
        const jsonString = JSON.stringify(dataSheet, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `data.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification(
          "Fichier de donn√©es JSON pr√™t √† √™tre t√©l√©charg√©.",
          "success"
        );
      });

      document.getElementById("excelFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const jsonData = XLSX.utils.sheet_to_json(
              workbook.Sheets[workbook.SheetNames[0]]
            );
            const importedData = jsonData
              .map((row) => {
                const lastMissionRemainder = parseInt(
                  row["Last Mission Remainder"] || 0
                );
                const plannedPurchase = parseInt(row["Planned Purchase"] || 0);
                const medicine = String(row.Medicine || "").trim();
                const expirationDate = String(
                  row["Expiration Date"] || ""
                ).trim();
                if (!medicine || !expirationDate) return null;
                return {
                  medicine,
                  expirationDate,
                  lastMissionRemainder,
                  plannedPurchase,
                  quantityBeforeMission: lastMissionRemainder + plannedPurchase,
                  consumption: null,
                  quantityAfterMission: null,
                };
              })
              .filter(Boolean);

            if (importedData.length === 0) {
              showNotification(
                "Aucune donn√©e valide trouv√©e dans le fichier Excel.",
                "error"
              );
              return;
            }
            dataSheet.push(...importedData);
            rerenderAll();
            showNotification("Fichier Excel import√© avec succ√®s !", "success");
          } catch (error) {
            showNotification(
              `Erreur de lecture du fichier Excel : ${error.message}`,
              "error"
            );
          }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = "";
      });

      document.getElementById("exportDataBtn").addEventListener("click", () => {
        const exportData = dataSheet.map((item) => ({
          M√©dicament: item.medicine,
          "Date d'Expiration": item.expirationDate,
          "Reste Mission Pr√©c√©dente": item.lastMissionRemainder,
          "Achat Pr√©vu": item.plannedPurchase,
          "Quantit√© Avant Mission": item.quantityBeforeMission,
          Consommation: item.consumption,
          "Quantit√© Apr√®s Mission": item.quantityAfterMission,
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Donn√©es");
        XLSX.writeFile(
          wb,
          `donnees-medicaments-${new Date().toISOString().split("T")[0]}.xlsx`
        );
        showNotification("Fiche de donn√©es export√©e avec succ√®s !", "success");
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        if (
          confirm(
            "√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action est irr√©versible !"
          )
        ) {
          dataSheet = [];
          rerenderAll();
          showNotification("Toutes les donn√©es ont √©t√© effac√©es.", "info");
        }
      });

      function rerenderAll() {
        renderSummary();
        renderDataTable();
      }

      // --- NOUVELLES FONCTIONS D'INITIALISATION ET DE SAUVEGARDE ---

      async function loadDataFromLocalFile() {
        try {
          const response = await fetch("data.json");
          if (!response.ok) {
            throw new Error("Fichier data.json non trouv√© ou erreur r√©seau.");
          }
          const text = await response.text();
          console.log(text);
          if (text && text.trim() !== '') { 
              const jsonData = JSON.parse(text);
              if (Array.isArray(jsonData)) {
                  dataSheet = jsonData;
                  showNotification("Donn√©es charg√©es depuis data.json", "info");
              }
          }
        } catch (error) {
          console.error("Erreur de chargement initial:", error.message);
          showNotification(
            "Impossible de charger data.json, utilisation des donn√©es par d√©faut.",
            "error"
          );
        } finally {
          rerenderAll(); // Affiche les donn√©es (charg√©es ou par d√©faut)
        }
      }

      window.addEventListener("beforeunload", function (e) {
        const message = "Pensez √† Sauvergarder Vos Donn√©es !";
        e.preventDefault();
        e.returnValue = message;
        return message;
      });

      // --- D√âMARRAGE DE L'APPLICATION ---
      loadDataFromLocalFile();
    </script>
  </body>
</html>
