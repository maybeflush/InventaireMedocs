<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi d'Inventaire de M√©dicaments</title>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
      /* ... (TOUT VOTRE CSS RESTE IDENTIQUE SAUF LES AJOUTS CI-DESSOUS) ... */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .content {
        padding: 30px;
      }

      .toolbar {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f8f9ff;
        color: #667eea;
        border: 2px solid #667eea;
      }

      .btn-secondary:hover {
        background: #667eea;
        color: white;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-info {
        background: #3b82f6;
        color: white;
      }

      .btn-info:hover {
        background: #2563eb;
      }

      input[type="file"] {
        display: none;
      }

      .file-label {
        padding: 12px 24px;
        background: #f8f9ff;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .file-label:hover {
        background: #667eea;
        color: white;
      }

      .add-medicine-section {
        background: #f8f9ff;
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .add-medicine-section h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .add-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .form-group label {
        font-size: 0.9em;
        font-weight: 600;
        color: #555;
      }

      .form-group input {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 0.9em;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.5em;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 40px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        font-size: 0.9em;
      }

      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        vertical-align: middle;
      }

      td input[type="number"],
      td input[type="text"] {
        width: 100%;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background-color: #f8f9ff;
      }

      .medicine-name {
        font-weight: 600;
        color: #333;
      }

      .quantity-badge {
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.9em;
        text-align: center;
        display: inline-block;
        min-width: 40px;
      }

      .consumption-badge {
        background: #ef4444;
      }

      .data-section {
        margin-top: 40px;
        padding-top: 40px;
        border-top: 2px solid #e0e0e0;
      }

      .action-btn {
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s;
        margin-right: 5px;
        color: white;
      }
      .edit-btn {
        background: #3b82f6;
      }
      .edit-btn:hover {
        background: #2563eb;
      }
      .delete-btn {
        background: #ef4444;
      }
      .delete-btn:hover {
        background: #dc2626;
      }
      .save-btn {
        background: #10b981;
      }
      .save-btn:hover {
        background: #059669;
      }
      .cancel-btn {
        background: #6b7280;
      }
      .cancel-btn:hover {
        background: #4b5563;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease-out;
        z-index: 1000;
      }

      .notification.success {
        background: #10b981;
      }
      .notification.error {
        background: #ef4444;
      }
      .notification.info {
        background: #3b82f6;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .instructions {
        background: #f8f9ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
      }
      .instructions p {
        margin-bottom: 8px;
        color: #555;
      }
      .instructions strong {
        color: #667eea;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .date-checkboxes {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: #f8f9ff;
        border-radius: 6px;
        transition: all 0.2s;
      }
      .checkbox-item:hover {
        background: #e8ebff;
      }
      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #667eea;
      }
      .checkbox-item label {
        cursor: pointer;
        font-size: 0.9em;
        color: #555;
        user-select: none;
        flex: 1;
      }
      .total-value {
        font-size: 1.2em;
        font-weight: 700;
        color: #667eea;
        padding: 8px 16px;
        background: #f8f9ff;
        border-radius: 8px;
        display: inline-block;
      }

      .sort-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }
      .sort-btn,
      .toggle-btn {
        padding: 8px 16px;
        background: #f8f9ff;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9em;
      }
      .sort-btn:hover,
      .toggle-btn:hover {
        background: #667eea;
        color: white;
      }
      .sort-btn.active {
        background: #667eea;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üíä Suivi d'Inventaire de M√©dicaments</h1>
        <p>G√©rez un inventaire de m√©dicaments de mission</p>
      </header>

      <div class="content">
        <div class="toolbar">
          <button class="btn btn-info" id="saveDataBtn">
            üíæ Enregistrer sur le Cloud
          </button>

          <label for="excelFile" class="file-label"> üì§ Importer Excel </label>
          <input type="file" id="excelFile" accept=".xlsx,.xls" />

          <button class="btn btn-secondary" id="exportDataBtn">
            üìä Exporter les Donn√©es
          </button>

          <button class="btn btn-danger" id="clearBtn">
            üóëÔ∏è Effacer Toutes les Donn√©es
          </button>
        </div>

        <div class="instructions">
          <p>
            <strong>Synchronisation :</strong> Les donn√©es sont charg√©es depuis
            le cloud √† chaque ouverture.
          </p>
          <p>
            <strong>Utiliser un tableur :</strong> On peut effacer toutes les
            donn√©es puis importer un fichier Excel
          </p>

          <strong>Colonnes Excel √† importer :</strong> Medicaments, Date d'Exp.,
          Reste Mission Prec., Achat Pr√©vu

          <p>
            <strong>Enregistrer sur le Cloud :</strong>Cliquez pour sauvegarder
            vos modifications sur le Cloud avant de quitter la page.
          </p>
        </div>

        <div class="add-medicine-section">
          <h3>‚ûï Ajouter une Nouvelle Entr√©e</h3>
          <div class="add-form">
            <div class="form-group">
              <label for="medicineName">Nom du M√©dicament</label>
              <input type="text" id="medicineName" placeholder="ex: Aspirine" />
            </div>
            <div class="form-group">
              <label for="expirationDate">Date d'Expiration</label>
              <input
                type="text"
                id="expirationDate"
                placeholder="ex: 01/07/2027"
              />
            </div>
            <div class="form-group">
              <label for="lastMissionRemainder">Reste Mission Pr√©c.</label>
              <input
                type="number"
                id="lastMissionRemainder"
                placeholder="ex: 20"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="plannedPurchase">Achat Pr√©vu</label>
              <input
                type="number"
                id="plannedPurchase"
                placeholder="ex: 100"
                min="0"
              />
            </div>
            <button class="btn btn-primary" id="addMedicineBtn">
              ‚ûï Ajouter
            </button>
          </div>
        </div>

        <div class="section-header">
          <h2>R√©sum√©</h2>
        </div>
        <div class="sort-controls">
          <span>Trier par :</span>
          <button id="sortSummaryByName" class="sort-btn active">
            Nom du M√©dicament ‚ñ≤
          </button>
        </div>
        <table id="summaryTable">
          <thead>
            <tr>
              <th>M√©dicament</th>
              <th>Lots par Date d'Expiration</th>
              <th>Total S√©lectionn√©</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>

        <div class="data-section" id="data-section-container">
          <div class="section-header">
            <h2>Fiche de Donn√©es</h2>
            <button id="toggleDataSheetBtn" class="toggle-btn">Masquer</button>
          </div>
          <div class="sort-controls" id="dataSheetSortControls">
            <span>Trier par :</span>
            <button id="sortDataByName" class="sort-btn active">
              Nom du M√©dicament
            </button>
            <button id="sortDataByDate" class="sort-btn">
              Date d'Expiration
            </button>
          </div>
          <table id="dataTable">
            <thead>
              <tr>
                <th>M√©dicament</th>
                <th>Date d'Exp.</th>
                <th>Reste Mission Pr√©c.</th>
                <th>Achat Pr√©vu</th>
                <th>Qt√© Avant Mission</th>
                <th>Consommation</th>
                <th>Qt√© Apr√®s Mission</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="dataBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      // <!--- !! IMPORTANT : COLLEZ VOTRE CONFIGURATION FIREBASE CI-DESSOUS !! --->

      const firebaseConfig = {
        apiKey: "AIzaSyD6xTZs-zlPQLD6WQebmrLuPvAfKxCKr_4",
        authDomain: "medocsanne.firebaseapp.com",
        databaseURL:
          "https://medocsanne-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "medocsanne",
        storageBucket: "medocsanne.firebasestorage.app",
        messagingSenderId: "1080882906327",
        appId: "1:1080882906327:web:b0d790d3a1638d8aa2dc92",
      };

      // Initialiser Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      // <!--- FIN DE LA CONFIGURATION FIREBASE --->

      let dataSheet = []; // Les donn√©es seront charg√©es depuis Firebase

      // Sorting State
      let summarySortOrder = "asc";
      let dataSheetSortKey = "medicine";
      let dataSheetSortOrder = "asc";

      function parseDate(dateStr) {
        const parts = dateStr.split("/");
        if (parts.length === 3) {
          return `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(
            2,
            "0"
          )}`;
        }
        return dateStr;
      }

      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      function saveSelectionsToLocalStorage() {
        const selections = {};
        document
          .querySelectorAll('#summaryTable input[type="checkbox"]')
          .forEach((cb) => {
            const key = `${cb.dataset.medicine}-${cb.dataset.date}`;
            selections[key] = cb.checked;
          });
        localStorage.setItem("medicineSelections", JSON.stringify(selections));
      }

      function groupByMedicine(data) {
        return data.reduce((acc, item) => {
          (acc[item.medicine] = acc[item.medicine] || []).push({
            date: item.expirationDate,
            quantity: item.quantityBeforeMission,
          });
          return acc;
        }, {});
      }

      function calculateTotal(medicine) {
        return Array.from(
          document.querySelectorAll(
            `input[data-medicine="${medicine}"]:checked`
          )
        ).reduce((total, cb) => total + parseInt(cb.dataset.quantity), 0);
      }

      function updateTotal(medicine) {
        const total = calculateTotal(medicine);
        const totalCell = document.getElementById(`total-${medicine}`);
        if (totalCell) {
          totalCell.textContent = total;
        }
        saveSelectionsToLocalStorage();
      }

      function renderSummary() {
        const grouped = groupByMedicine(dataSheet);
        const summaryBody = document.getElementById("summaryBody");
        summaryBody.innerHTML = "";
        const savedSelections = JSON.parse(
          localStorage.getItem("medicineSelections") || "{}"
        );

        const sortedMedicines = Object.keys(grouped).sort((a, b) => {
          const comparison = a.localeCompare(b);
          return summarySortOrder === "asc" ? comparison : -comparison;
        });

        sortedMedicines.forEach((medicine) => {
          const row = document.createElement("tr");
          const medicineCell = document.createElement("td");
          medicineCell.className = "medicine-name";
          medicineCell.textContent = medicine;
          const dateCell = document.createElement("td");
          const checkboxContainer = document.createElement("div");
          checkboxContainer.className = "date-checkboxes";
          grouped[medicine].sort((a, b) =>
            parseDate(a.date).localeCompare(parseDate(b.date))
          );
          grouped[medicine].forEach((item, index) => {
            const checkboxItem = document.createElement("div");
            checkboxItem.className = "checkbox-item";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            const checkboxId = `${medicine.replace(
              /\s+/g,
              "_"
            )}-${item.date.replace(/\//g, "-")}-${index}`;
            checkbox.id = checkboxId;
            checkbox.dataset.medicine = medicine;
            checkbox.dataset.date = item.date;
            checkbox.dataset.quantity = item.quantity;
            const key = `${medicine}-${item.date}`;
            if (savedSelections[key]) checkbox.checked = true;
            checkbox.addEventListener("change", () => updateTotal(medicine));
            const label = document.createElement("label");
            label.htmlFor = checkboxId;
            label.innerHTML = `${item.date} <span class="quantity-badge">${item.quantity}</span>`;
            checkboxItem.append(checkbox, label);
            checkboxContainer.appendChild(checkboxItem);
          });
          dateCell.appendChild(checkboxContainer);
          const totalCell = document.createElement("td");
          const totalValue = document.createElement("span");
          totalValue.className = "total-value";
          totalValue.id = `total-${medicine}`;
          totalCell.appendChild(totalValue);
          row.append(medicineCell, dateCell, totalCell);
          summaryBody.appendChild(row);
          updateTotal(medicine);
        });
      }

      function updateConsumption(index) {
        const rowInput = document.getElementById(`qam-${index}`);
        const newQAM = rowInput.value !== "" ? parseInt(rowInput.value) : null;
        if (newQAM === null) {
          dataSheet[index].quantityAfterMission = null;
          dataSheet[index].consumption = null;
        } else {
          const quantityBefore = dataSheet[index].quantityBeforeMission;
          if (newQAM > quantityBefore) {
            showNotification(
              "La Qt√© apr√®s mission ne peut pas d√©passer la Qt√© avant.",
              "error"
            );
            rowInput.value =
              dataSheet[index].quantityAfterMission !== null
                ? dataSheet[index].quantityAfterMission
                : "";
            return;
          }
          dataSheet[index].quantityAfterMission = newQAM;
          dataSheet[index].consumption = quantityBefore - newQAM;
        }
        rerenderAll(); // Re-render to update the consumption column
        showNotification(
          "Consommation mise √† jour localement. Pensez √† sauvegarder.",
          "info"
        );
      }

      function renderDataTable() {
        const dataBody = document.getElementById("dataBody");
        dataBody.innerHTML = "";

        const indexedData = dataSheet.map((item, index) => ({
          ...item,
          originalIndex: index,
        }));

        indexedData.sort((a, b) => {
          let valA, valB;
          if (dataSheetSortKey === "expirationDate") {
            valA = parseDate(a.expirationDate);
            valB = parseDate(b.expirationDate);
          } else {
            valA = a.medicine.toLowerCase();
            valB = b.medicine.toLowerCase();
          }
          if (valA < valB) return dataSheetSortOrder === "asc" ? -1 : 1;
          if (valA > valB) return dataSheetSortOrder === "asc" ? 1 : -1;
          return 0;
        });

        indexedData.forEach((item) => {
          const { originalIndex } = item;
          const row = document.createElement("tr");

          if (item.isEditing) {
            // --- EDIT MODE ROW ---
            row.innerHTML = `
                <td><input type="text" id="edit-med-${originalIndex}" value="${item.medicine}"></td>
                <td><input type="text" id="edit-exp-${originalIndex}" value="${item.expirationDate}"></td>
                <td><input type="number" id="edit-rem-${originalIndex}" value="${item.lastMissionRemainder}" oninput="updateQteAvantMission(${originalIndex})"></td>
                <td><input type="number" id="edit-pur-${originalIndex}" value="${item.plannedPurchase}" oninput="updateQteAvantMission(${originalIndex})"></td>
                <td><span class="quantity-badge" id="edit-qte-${originalIndex}">${item.quantityBeforeMission}</span></td>
                <td>inconnue</td>
                <td></td>
                <td>
                    <button class="action-btn save-btn" onclick="saveEdit(${originalIndex})">üíæ</button>
                    <button class="action-btn cancel-btn" onclick="cancelEdit(${originalIndex})">‚ùå</button>
                </td>
            `;
          } else {
            // --- NORMAL ROW ---
            const consumptionValue =
              item.consumption !== null
                ? `<span class="quantity-badge consumption-badge">${item.consumption}</span>`
                : "inconnue";
            const qamValue =
              item.quantityAfterMission !== null
                ? item.quantityAfterMission
                : "";
            row.innerHTML = `
                <td class="medicine-name">${item.medicine}</td>
                <td>${item.expirationDate}</td>
                <td>${item.lastMissionRemainder}</td>
                <td>${item.plannedPurchase}</td>
                <td><span class="quantity-badge">${item.quantityBeforeMission}</span></td>
                <td>${consumptionValue}</td>
                <td>
                    <input type="number" id="qam-${originalIndex}" value="${qamValue}" min="0" onchange="updateConsumption(${originalIndex})"/>
                </td>
                <td>
                    <button class="action-btn edit-btn" onclick="startEdit(${originalIndex})">‚úèÔ∏è √âditer</button>
                    <button class="action-btn delete-btn" onclick="deleteMedicine(${originalIndex})">üóëÔ∏è Supprimer</button>
                </td>
            `;
          }
          dataBody.appendChild(row);
        });
      }

      function deleteMedicine(index) {
        if (confirm("√ätes-vous s√ªr de vouloir supprimer cette entr√©e ?")) {
          dataSheet.splice(index, 1);
          rerenderAll();
          showNotification(
            "Entr√©e supprim√©e localement. Pensez √† sauvegarder.",
            "info"
          );
        }
      }

      // --- EDIT FUNCTIONS ---
      function startEdit(index) {
        dataSheet[index].isEditing = true;
        renderDataTable();
      }

      function cancelEdit(index) {
        delete dataSheet[index].isEditing;
        renderDataTable();
      }

      function saveEdit(index) {
        const newMed = document
          .getElementById(`edit-med-${index}`)
          .value.trim();
        const newExp = document
          .getElementById(`edit-exp-${index}`)
          .value.trim();
        const newRem =
          parseInt(document.getElementById(`edit-rem-${index}`).value) || 0;
        const newPur =
          parseInt(document.getElementById(`edit-pur-${index}`).value) || 0;

        if (!newMed || !newExp) {
          showNotification(
            "Le nom et la date ne peuvent pas √™tre vides.",
            "error"
          );
          return;
        }

        dataSheet[index].medicine = newMed;
        dataSheet[index].expirationDate = newExp;
        dataSheet[index].lastMissionRemainder = newRem;
        dataSheet[index].plannedPurchase = newPur;
        dataSheet[index].quantityBeforeMission = newRem + newPur;
        delete dataSheet[index].isEditing;

        rerenderAll();
        showNotification("Ligne mise √† jour. Pensez √† sauvegarder.", "info");
      }

      function updateQteAvantMission(index) {
        const rem =
          parseInt(document.getElementById(`edit-rem-${index}`).value) || 0;
        const pur =
          parseInt(document.getElementById(`edit-pur-${index}`).value) || 0;
        document.getElementById(`edit-qte-${index}`).textContent = rem + pur;
      }

      document
        .getElementById("addMedicineBtn")
        .addEventListener("click", (e) => {
          const medicine = document.getElementById("medicineName").value.trim();
          const expirationDate = document
            .getElementById("expirationDate")
            .value.trim();
          const lastMissionRemainder =
            parseInt(document.getElementById("lastMissionRemainder").value) ||
            0;
          const plannedPurchase =
            parseInt(document.getElementById("plannedPurchase").value) || 0;

          if (!medicine || !expirationDate) {
            showNotification(
              "Le nom du m√©dicament et la date d'expiration sont requis.",
              "error"
            );
            return;
          }

          dataSheet.push({
            medicine,
            expirationDate,
            lastMissionRemainder,
            plannedPurchase,
            quantityBeforeMission: lastMissionRemainder + plannedPurchase,
            consumption: null,
            quantityAfterMission: null,
          });

          rerenderAll();
          document.getElementById("medicineName").value = "";
          document.getElementById("expirationDate").value = "";
          document.getElementById("lastMissionRemainder").value = "";
          document.getElementById("plannedPurchase").value = "";

          showNotification(
            "M√©dicament ajout√© localement. Pensez √† sauvegarder.",
            "info"
          );
        });

      document
        .getElementById("sortSummaryByName")
        .addEventListener("click", (e) => {
          summarySortOrder = summarySortOrder === "asc" ? "desc" : "asc";
          e.target.textContent = `Nom du M√©dicament ${
            summarySortOrder === "asc" ? "‚ñ≤" : "‚ñº"
          }`;
          renderSummary();
        });

      document
        .getElementById("sortDataByName")
        .addEventListener("click", (e) => {
          dataSheetSortKey = "medicine";
          dataSheetSortOrder = dataSheetSortOrder === "asc" ? "desc" : "asc";
          document.getElementById("sortDataByDate").classList.remove("active");
          e.target.classList.add("active");
          renderDataTable();
        });

      document
        .getElementById("sortDataByDate")
        .addEventListener("click", (e) => {
          dataSheetSortKey = "expirationDate";
          dataSheetSortOrder = dataSheetSortOrder === "asc" ? "desc" : "asc";
          document.getElementById("sortDataByName").classList.remove("active");
          e.target.classList.add("active");
          renderDataTable();
        });

      document
        .getElementById("toggleDataSheetBtn")
        .addEventListener("click", (e) => {
          const table = document.getElementById("dataTable");
          const controls = document.getElementById("dataSheetSortControls");
          const isHidden = table.style.display === "none";
          if (isHidden) {
            table.style.display = "";
            controls.style.display = "flex";
            e.target.textContent = "Masquer";
          } else {
            table.style.display = "none";
            controls.style.display = "none";
            e.target.textContent = "Afficher";
          }
        });

      document.getElementById("excelFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const jsonData = XLSX.utils.sheet_to_json(
              workbook.Sheets[workbook.SheetNames[0]]
            );

            const importedData = jsonData
              .map((row) => {
                const lastMissionRemainder = parseInt(
                  row["Reste Mission Prec."] ||
                    row["Last Mission Remainder"] ||
                    0
                );
                const plannedPurchase = parseInt(
                  row["Achat Pr√©vu"] || row["Planned Purchase"] || 0
                );
                const medicine = String(
                  row["Medicaments"] || row.Medicine || ""
                ).trim();
                const expirationDate = String(
                  row["Date d'Exp."] || row["Expiration Date"] || ""
                ).trim();

                if (!medicine || !expirationDate) return null;

                return {
                  medicine,
                  expirationDate,
                  lastMissionRemainder,
                  plannedPurchase,
                  quantityBeforeMission: lastMissionRemainder + plannedPurchase,
                  consumption: null,
                  quantityAfterMission: null,
                };
              })
              .filter(Boolean);

            if (importedData.length === 0) {
              showNotification(
                "Aucune donn√©e valide trouv√©e dans le fichier Excel.",
                "error"
              );
              return;
            }
            dataSheet.push(...importedData);
            rerenderAll();
            showNotification(
              "Fichier Excel import√©. Pensez √† sauvegarder.",
              "info"
            );
          } catch (error) {
            showNotification(
              `Erreur de lecture du fichier Excel : ${error.message}`,
              "error"
            );
          }
        };
        reader.readAsArrayBuffer(file);
        e.target.value = "";
      });

      document.getElementById("exportDataBtn").addEventListener("click", () => {
        const exportData = dataSheet.map((item) => ({
          Medicaments: item.medicine,
          "Date d'Exp.": item.expirationDate,
          "Reste Mission Prec.": item.lastMissionRemainder,
          "Achat Pr√©vu": item.plannedPurchase,
          "Qte Avant Mission": item.quantityBeforeMission,
          Consommation: item.consumption,
          "Qte Apres Mission": item.quantityAfterMission,
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Donn√©es");
        XLSX.writeFile(
          wb,
          `donnees-medicaments-${new Date().toISOString().split("T")[0]}.xlsx`
        );
        showNotification("Fiche de donn√©es export√©e avec succ√®s !", "success");
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        if (
          confirm(
            "√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action est irr√©versible !"
          )
        ) {
          dataSheet = [];
          rerenderAll();
          showNotification(
            "Donn√©es effac√©es localement. Pensez √† sauvegarder.",
            "info"
          );
        }
      });

      function rerenderAll() {
        renderSummary();
        renderDataTable();
      }

      function loadDataFromFirebase() {
        const inventoryRef = database.ref("inventory");
        inventoryRef.on("value", (snapshot) => {
          const data = snapshot.val();
          dataSheet = data ? data : [];
          showNotification("Donn√©es synchronis√©es depuis le cloud.", "info");
          rerenderAll();
        });
      }

      function saveDataToFirebase() {
        // Cr√©e une copie des donn√©es sans la propri√©t√© temporaire 'isEditing'
        const dataToSave = JSON.parse(JSON.stringify(dataSheet));
        dataToSave.forEach((item) => delete item.isEditing);

        const inventoryRef = database.ref("inventory");
        inventoryRef
          .set(dataToSave)
          .then(() => {
            showNotification(
              "Donn√©es enregistr√©es sur le cloud avec succ√®s !",
              "success"
            );
          })
          .catch((error) => {
            showNotification(
              "Erreur de sauvegarde : " + error.message,
              "error"
            );
          });
      }

      document
        .getElementById("saveDataBtn")
        .addEventListener("click", saveDataToFirebase);

      loadDataFromFirebase();
    </script>
  </body>
</html>
